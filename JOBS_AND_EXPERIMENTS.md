## Jobs vs Experiments

How does the code work?

The below documentation is written with the Banneduser experiment in mind. Previous/other experiments may differ in logic\!

### **Jobs**

Jobs gather data; Experiments operate on gathered data.

Jobs are tasks that usually gather data from a subreddit. 

Types of data:  
- Posts (new/top/contr/hot)  
- Comments   
- Mod actions

Jobs are scheduled using `schedule_jobs.py.`

NOTE: Jobs occasionally have dependencies on each other!  
For example, gathering modactions data requires that an entry in the Subreddit table exists, which is generated by gathering new posts data at least once. 

That is:  
  `CS_ENV=production python3 schedule_jobs.py SUBREDDIT modactions 300`
  depends on  
  `CS_ENV=production python3 schedule_jobs.py SUBREDDIT new 300`

  


### **Experiments**

Experiments operate on gathered data. Some experiments may query the API; for the Banneduser experiment, experiment runs solely from the database.

Experiments are scheduled using

- `schedule_experiments.py.`  
  - for scheduled experiments  
- `run_experiment.py`  
  - to run an experiment once, or to enter the experiment in the database.  
    - For the Banneduser experiment, the experiment is run using event hooks after each modaction. Thus, upon first system setup, we have to run `run_experiment.py` once, which will not itself run the experiment (experiment is run with an event hook), but will enter the experiment config into the database under the Experiments table.

Experiments are configured in `config/experiments/` as a YAML file. The contains information about randomizations, different variables for different conditions and arms, as well as event hooks.

The YAML file is structured as such:

- `ENVIRONMENT` (e.g. ‘test’ or ‘production’ or ‘development’)  
  - `subreddit`: name of subreddit
  - `subreddit_id`: subreddit ID (without the `t5_` prefix)
  - `username` (of authenticated reddit account):  
  - (other variables)  
  - `conditions`:  
    - `conditionA`:  
      - `arms`:  
        - `arm_0`  
        - `arm_1`  
    - `conditionB`:  
  - `controller`:  
  - `start_time`:  
  - `end_time`:  
  - `event_hooks`:  
    - `NAME_OF_EVENT_HOOK`.

### Experiment Event hooks

Experiments can also add a series of event hooks before or after a job. These event hooks are loaded into the database (into the event\_hooks table) from the YAML experiment config file.

For the Banneduser experiment, the event hook looks like

```
banneduser_eventhook:  
  is_active: True  
  call_when: EventWhen.AFTER  
  caller_controller: ModeratorController  
  caller_method: archive_mod_action_page  
  callee_module: app.controllers.banneduser_experiment_controller  
  callee_controller: BanneduserExperimentController  
  callee_method: find_intervention_target
```

Thus, after running, ModeratorController’s `archive_mod_action_page()` calls BanneduserExperimentController `find_intervention_target()`.

## Logic flow for the Banneduser g experiment

- Scheduled modaction job gets mod action history. 
  (`controller.py` :: `fetch_mod_action_history`)
  - → runs `moderator_controller.py` :: `archive_mod_action_page`  
    - → `archive_mod_action_page` gets mod_action events and stores in database  
  - → After mod actions are stored in database, event hook runs `banneduser_experiment_controller.py` :: `find_intervention_target` 
    - Finds intervention targets and sends message with `messaging_controller.py` :: `send_messages`

  